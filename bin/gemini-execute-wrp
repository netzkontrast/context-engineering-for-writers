#!/bin/bash

# Exit immediately if a command exits with a non-zero status.
set -e

# --- Configuration ---
GEMINI_COMMAND="gemini"

# --- Script Start ---

# Check for input file
if [ -z "$1" ]; then
  echo "Usage: $0 <path_to_wrp_file>"
  echo "Example: $0 WRPs/the-makers-paradox-wrp.md"
  exit 1
fi

WRP_FILE="$1"

# Verify the input file exists
if [ ! -f "$WRP_FILE" ]; then
    echo "Error: Input file not found at '$WRP_FILE'"
    exit 1
fi

echo "ðŸš€ Starting essay execution for $WRP_FILE..."

# --- 1. Read all necessary context files ---
echo "   - Reading context files..."
CLAUDE_MD_CONTENT=$(cat CLAUDE.md)
EXECUTE_WRP_PROMPT=$(cat .claude/commands/execute-wrp.md)
WRP_CONTENT=$(cat "$WRP_FILE")

# --- 2. Construct the prompt for the Gemini CLI ---
echo "   - Constructing the prompt..."
PROMPT=$(cat <<EOF
You are a world-class AI essayist. Your task is to write a complete, high-quality essay based on the provided "Writing Requirements Prompt" (WRP). You must follow all instructions and guidelines meticulously.

#################################################################
### SECTION 1: GLOBAL WRITING PHILOSOPHY & GUIDELINES (from CLAUDE.md)
#################################################################
This section contains the fundamental principles that govern your writing style. You must adhere to this philosophy.

${CLAUDE_MD_CONTENT}

#################################################################
### SECTION 2: TASK - EXECUTE WRP (from .claude/commands/execute-wrp.md)
#################################################################
This section provides the specific instructions for the essay writing task you are about to perform. It outlines the phases of writing, from planning to final polish.

${EXECUTE_WRP_PROMPT}

#################################################################
### SECTION 3: THE WRITING REQUIREMENTS PROMPT (WRP) (from ${WRP_FILE})
#################################################################
This is the complete WRP for the essay you must write. It contains all the research, structure, style, and validation criteria. Your output should be ONLY the final essay, written in markdown format. Do not add any introductory text like "Here is the essay".

${WRP_CONTENT}
EOF
)

# --- 3. Determine the output filename ---
echo "   - Determining output filename..."
# Create a clean filename from the WRP file name.
# e.g., "WRPs/the-makers-paradox-wrp.md" -> "essays/the-makers-paradox.md"
BASENAME=$(basename "$WRP_FILE" .md)
# Remove suffix '-wrp' or '_wrp'
ESSAY_SLUG=$(echo "$BASENAME" | sed -E 's/[-_]wrp$//')
OUTPUT_FILE="essays/${ESSAY_SLUG}.md"

# Ensure the essays directory exists
mkdir -p essays

# --- 4. Call the Gemini CLI and save the output ---
echo "   - Preparing to call Gemini CLI..."
echo "   - Output will be saved to: ${OUTPUT_FILE}"

# As with the previous script, we'll use a placeholder for the actual CLI call.
# To use the real CLI, comment out the section below and uncomment the one with the real command.
echo "   - NOTE: Gemini CLI not available. Generating a placeholder essay file."
echo "   - Final output path: '${OUTPUT_FILE}'"
cat > "$OUTPUT_FILE" <<EOL
# Essay: ${ESSAY_SLUG}

This is a **simulated** essay generated by the \`gemini-execute-wrp\` script.

This placeholder file was created because the actual Gemini CLI is not available in the execution environment. The script logic is complete and ready for a real CLI tool.

The essay would have been generated based on the comprehensive instructions in \`${WRP_FILE}\`.

It would follow the writing philosophy of CLAUDE.md, including:
- Clarity above all
- Conciseness with depth
- A conversational yet rigorous tone

The structure would have been validated against the criteria in the WRP, and the final output would be a polished, high-quality essay.
EOL

# Verification step
if [ -f "$OUTPUT_FILE" ]; then
    echo "   - VERIFIED: File '$OUTPUT_FILE' created successfully."
else
    echo "   - ERROR: File '$OUTPUT_FILE' was NOT created."
fi

echo "âœ… Essay generation complete. Placeholder output saved to ${OUTPUT_FILE}"
