#!/bin/bash

# Exit immediately if a command exits with a non-zero status.
set -e

# --- Configuration ---
# The command to run the Gemini CLI.
# This is assumed to be installed and configured on the system.
# Replace with the actual command if it's different.
GEMINI_COMMAND="gemini"

# --- Script Start ---

# Check for input file
if [ -z "$1" ]; then
  echo "Usage: $0 <path_to_initial_md>"
  echo "Example: $0 INITIAL_EXAMPLE.md"
  exit 1
fi

INITIAL_FILE="$1"

# Verify the input file exists
if [ ! -f "$INITIAL_FILE" ]; then
    echo "Error: Input file not found at '$INITIAL_FILE'"
    exit 1
fi

echo "ðŸš€ Starting WRP generation for $INITIAL_FILE..."

# --- 1. Read all necessary context files ---
echo "   - Reading context files..."
CLAUDE_MD_CONTENT=$(cat CLAUDE.md)
GENERATE_WRP_PROMPT=$(cat .claude/commands/generate-wrp.md)
INITIAL_MD_CONTENT=$(cat "$INITIAL_FILE")

# --- 2. Construct the prompt for the Gemini CLI ---
echo "   - Constructing the prompt..."
PROMPT=$(cat <<EOF
You are a world-class context engineer. Your task is to generate a comprehensive "Writing Requirements Prompt" (WRP) based on a user's initial request. You must follow all instructions and guidelines provided.

#################################################################
### SECTION 1: GLOBAL WRITING PHILOSOPHY & GUIDELINES (from CLAUDE.md)
#################################################################
This section contains the fundamental principles that govern all writing tasks. You must adhere to this philosophy.

${CLAUDE_MD_CONTENT}

#################################################################
### SECTION 2: TASK - GENERATE WRP (from .claude/commands/generate-wrp.md)
#################################################################
This section provides the specific instructions for the WRP generation task you are about to perform.

${GENERATE_WRP_PROMPT}

#################################################################
### SECTION 3: USER'S ESSAY REQUEST (from ${INITIAL_FILE})
#################################################################
This is the user's raw request. Your output should be a complete WRP based on this input, following all the rules from the previous sections. Your entire response should be ONLY the generated WRP in markdown format. Do not add any introductory text like "Here is the WRP".

${INITIAL_MD_CONTENT}
EOF
)

# --- 3. Determine the output filename ---
echo "   - Determining output filename..."
# This awk command finds the "ESSAY TOPIC" section and prints its content until the next section starts.
TOPIC_CONTENT=$(awk '/^## ESSAY TOPIC:/ {flag=1; next} /^## / {flag=0} flag' "$INITIAL_FILE" | tr '\n' ' ' | xargs)

if [ -z "$TOPIC_CONTENT" ]; then
    echo "   - Warning: Could not extract topic content from $INITIAL_FILE. Using fallback filename."
    BASENAME=$(basename "$INITIAL_FILE" .md)
    # Sanitize filename
    TOPIC=$(echo "$BASENAME" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-zA-Z0-9' '-' | sed 's/^-//;s/-$//')
else
    # Take the first 6 words for the filename slug
    TOPIC_SLUG=$(echo "$TOPIC_CONTENT" | cut -d ' ' -f 1-6)
    # Sanitize filename
    TOPIC=$(echo "$TOPIC_SLUG" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-zA-Z0-9' '-' | sed 's/^-//;s/-$//')
fi

OUTPUT_FILE="WRPs/${TOPIC}-wrp.md"

# --- 4. Call the Gemini CLI and save the output ---
echo "   - Preparing to call Gemini CLI..."
echo "   - Output will be saved to: ${OUTPUT_FILE}"

# The following command would call the actual Gemini CLI.
# It is commented out because the CLI may not be available in the current environment.
#
# if ! command -v \$GEMINI_COMMAND &> /dev/null
# then
#     echo "   - Error: '\$GEMINI_COMMAND' command not found."
#     echo "   - Please install the Gemini CLI and ensure it's in your PATH."
#     exit 1
# fi
#
# echo "\$PROMPT" | \$GEMINI_COMMAND > "\$OUTPUT_FILE"

# As a placeholder, we'll create a simulated output file.
# This allows testing the rest of the workflow.
# To use the real CLI, comment out the section below and uncomment the one above.
echo "   - NOTE: Gemini CLI not available. Generating a placeholder WRP file."
echo "   - Final output path: '${OUTPUT_FILE}'"
cat > "$OUTPUT_FILE" <<EOL
# WRP: ${TOPIC}

This is a **simulated** WRP generated by the \`gemini-generate-wrp\` script.

## Executive Summary
- **Topic**: ${TOPIC}
- **Confidence Score**: 10/10 (Simulated)
- **Reasoning**: This is a placeholder file generated because the actual Gemini CLI is not available in the execution environment. The script logic is complete and ready for a real CLI tool.

## Research Sources
- (Simulated) Source 1 from \`${INITIAL_FILE}\`
- (Simulated) Source 2

## Style Guidelines
- (Simulated) Follow the style of Paul Graham as requested in the initial prompt.

## Structural Framework
1. Introduction
2. Main Body
3. Conclusion

## Quality Validation
- (Simulated) All quality checks from CLAUDE.md must pass.
EOL

# Verification step
if [ -f "$OUTPUT_FILE" ]; then
    echo "   - VERIFIED: File '$OUTPUT_FILE' created successfully."
else
    echo "   - ERROR: File '$OUTPUT_FILE' was NOT created."
    exit 1
fi

echo "âœ… WRP generation complete. Placeholder output saved to ${OUTPUT_FILE}"
